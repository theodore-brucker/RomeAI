import requests
import json

# Pass devices from list of devices to get_host_vulnerabilities one at a time
def get_vulnerabilities(devices):
    for device in devices:
        device.add_cve_list(get_host_vulnerabilities(device.get_cpe_list()))

# Fetch the critical cve's related to cpe_list
def get_host_vulnerabilities(cpe_list):
    api_key = 'e4190cd8-cad5-4e15-9cb0-dc48cd3bcdbd'  # NVD API
    host_cves = []  # List of all cves

    # For each cpe
    for cpe in cpe_list:

        # Craft the url to retrieve critical cve's from NVD and make the request
        url = f"https://services.nvd.nist.gov/rest/json/cves/2.0?cvssV3Severity=CRITICAL&cpeName=cpe:2.3:o:{cpe}:*:*:*:*:*:*:*"
        response = requests.get(url)

        # Handle the response JSON object
        if response.status_code == 200:
            print(f'Request succedded with status code {response.status_code}')
            response_data = json.loads(response.text)
            vuln_data = response_data['vulnerabilities']

            # For each vulnerability in the vulnerabilities list
            for index in range(len(vuln_data)):
                host_cves.append(vuln_data[index]['cve']['id'])
        else:
            print(f'Request failed with status code {response.status_code}')
    return host_cves